name:  CI - SonarCloud & Snyk

on:
  push:
    branches:
      - main  # Trigger on push to the main branch
  workflow_dispatch:  
    inputs:
      branch:
        description: 'Feature branch to deploy'
        required: true
        type: string  # User input for the feature branch to deploy

permissions:
  id-token: write
  contents: read

jobs:
  # Detect language job
  detect-language:
    name: Detect repository language(s)
    runs-on: ubuntu-latest
    outputs:
      has_maven: ${{ steps.detect.outputs.has_maven }}
      has_node: ${{ steps.detect.outputs.has_node }}
      has_python: ${{ steps.detect.outputs.has_python }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: detect
        name: Detect files
        run: |
          echo "has_maven=false" >> $GITHUB_OUTPUT
          echo "has_node=false" >> $GITHUB_OUTPUT
          echo "has_python=false" >> $GITHUB_OUTPUT
          if [ -f pom.xml ]; then echo "has_maven=true" >> $GITHUB_OUTPUT; fi
          if [ -f package.json ]; then echo "has_node=true" >> $GITHUB_OUTPUT; fi
          if [ -f requirements.txt ] || [ -f setup.py ] || [ -f pyproject.toml ]; then echo "has_python=true" >> $GITHUB_OUTPUT; fi

  # SonarCloud analysis job
  sonarcloud:
    name: SonarCloud analysis
    runs-on: ubuntu-latest
    needs: detect-language
    env:
      SONAR_HOST_URL: https://sonarcloud.io
    steps:
      - uses: actions/checkout@v4

      # Java / Maven analysis
      - name: Set up Java 11 (for Maven)
        if: ${{ needs.detect-language.outputs.has_maven == 'true' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Debug Maven Build
        if: ${{ needs.detect-language.outputs.has_maven == 'true' }}
        run: |
          mvn -version
          mvn clean verify

      - name: Maven build & SonarCloud
        if: ${{ needs.detect-language.outputs.has_maven == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORG: ${{ secrets.SONAR_ORG }}
        run: |
          mvn -B -DskipTests clean verify sonar:sonar \
            -Dsonar.host.url=${SONAR_HOST_URL} \
            -Dsonar.organization=${SONAR_ORG} \
            -Dsonar.login=${SONAR_TOKEN}

      # Node / JavaScript analysis
      - name: Set up Node.js
        if: ${{ needs.detect-language.outputs.has_node == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: SonarCloud Scan (Node)
        if: ${{ needs.detect-language.outputs.has_node == 'true' }}
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.projectKey=Uniper-REM_template
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.sources=src
            -Dsonar.tests=test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Python analysis
      - name: Set up Python
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (Python)
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest pytest-cov

      - name: Run Python tests with coverage
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        run: |
          PYTHONPATH=. pytest --cov=. --cov-report=xml

      - name: Debug files for SonarCloud Scan (Python)
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        run: |
          ls -al
          ls -al coverage.xml

      - name: SonarCloud Scan (Python)
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          args: >
            -Dsonar.projectKey=Uniper-REM_template
            -Dsonar.organization=${{ secrets.SONAR_ORG }}
            -Dsonar.python.coverage.reportPaths=coverage.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Snyk vulnerability scan job
  snyk-scan:
    name: Snyk vulnerability scan
    runs-on: ubuntu-latest
    needs: [detect-language, sonarcloud]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (for Maven projects)
        if: ${{ needs.detect-language.outputs.has_maven == 'true' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Set up Node (for Node projects)
        if: ${{ needs.detect-language.outputs.has_node == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Ensure Node (for Snyk CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python (for Python projects)
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Install Snyk CLI
        run: snyk config clear

      - name: Authenticate with Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }}

      - name: Run Snyk test (all detected projects)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --all-projects

      - name: Run Snyk monitor (optional)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk monitor
