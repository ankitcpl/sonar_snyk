name: CI - Snyk

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  detect-language:
    name: Detect repository language(s)
    runs-on: ubuntu-latest
    outputs:
      has_maven: ${{ steps.detect.outputs.has_maven }}
      has_node: ${{ steps.detect.outputs.has_node }}
      has_python: ${{ steps.detect.outputs.has_python }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: detect
        name: Detect files
        run: |
          echo "has_maven=false" >> $GITHUB_OUTPUT
          echo "has_node=false" >> $GITHUB_OUTPUT
          echo "has_python=false" >> $GITHUB_OUTPUT
          if [ -f pom.xml ]; then echo "has_maven=true" >> $GITHUB_OUTPUT; fi
          if [ -f package.json ]; then echo "has_node=true" >> $GITHUB_OUTPUT; fi
          if [ -f requirements.txt ] || [ -f setup.py ] || [ -f pyproject.toml ]; then echo "has_python=true" >> $GITHUB_OUTPUT; fi

  snyk-scan:
    name: Snyk vulnerability scan
    runs-on: ubuntu-latest
    needs: detect-language  # Removed the dependency on sonarcloud
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java (for Maven projects)
        if: ${{ needs.detect-language.outputs.has_maven == 'true' }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Set up Node (for Node projects)
        if: ${{ needs.detect-language.outputs.has_node == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Ensure Node (for Snyk CLI)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Python (for Python projects)
        if: ${{ needs.detect-language.outputs.has_python == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Snyk CLI
        run: npm install -g snyk

      - name: Install Snyk CLI
        run: snyk config clear
      
      # - name: Clear Snyk cache
      #   run: |
      #     rm -rf ~/.config/snyk
        
      - name: Authenticate Snyk
        run: snyk auth ${{ secrets.SNYK_TOKEN }} --debug

      - name: Run Snyk test (all detected projects)
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --all-projects --skip-unresolved --debug
